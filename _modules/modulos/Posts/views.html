<!DOCTYPE html>

<html lang="es" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>modulos.Posts.views &#8212; documentación de Proyecto IS2 grupo 6 - 0.1</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=c058f7c8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=9c9b61ad"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/translations.js?v=d190bf04"></script>
    <link rel="index" title="Índice" href="../../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Código fuente para modulos.Posts.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AnonymousUser</span><span class="p">,</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">django.core.paginator</span> <span class="kn">import</span> <span class="n">Paginator</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span>
<span class="kn">from</span> <span class="nn">django.db.models.query_utils</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.http.response</span> <span class="kn">import</span> <span class="p">(</span><span class="n">HttpResponseBadRequest</span><span class="p">,</span>
                                  <span class="n">HttpResponseForbidden</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>

<span class="kn">from</span> <span class="nn">modulos.Authorization.decorators</span> <span class="kn">import</span> <span class="n">permissions_required</span>
<span class="kn">from</span> <span class="nn">modulos.Authorization.permissions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">KANBAN_VIEW_PERMISSION</span><span class="p">,</span>
                                               <span class="n">POST_APPROVE_PERMISSION</span><span class="p">,</span>
                                               <span class="n">POST_CREATE_PERMISSION</span><span class="p">,</span>
                                               <span class="n">POST_DELETE_PERMISSION</span><span class="p">,</span>
                                               <span class="n">POST_EDIT_PERMISSION</span><span class="p">,</span>
                                               <span class="n">POST_PUBLISH_PERMISSION</span><span class="p">,</span>
                                               <span class="n">POST_REJECT_PERMISSION</span><span class="p">,</span>
                                               <span class="n">POST_REVIEW_PERMISSION</span><span class="p">,</span>
                                               <span class="n">user_has_access_to_category</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">modulos.Authorization.roles</span> <span class="kn">import</span> <span class="n">ADMIN</span>
<span class="kn">from</span> <span class="nn">modulos.Categories.models</span> <span class="kn">import</span> <span class="n">Category</span>
<span class="kn">from</span> <span class="nn">modulos.Posts.buscador</span> <span class="kn">import</span> <span class="n">buscador</span>
<span class="kn">from</span> <span class="nn">modulos.Posts.disqus</span> <span class="kn">import</span> <span class="n">get_disqus_stats</span>
<span class="kn">from</span> <span class="nn">modulos.Posts.forms</span> <span class="kn">import</span> <span class="n">NewPostForm</span><span class="p">,</span> <span class="n">PostsListFilter</span><span class="p">,</span> <span class="n">SearchPostForm</span>
<span class="kn">from</span> <span class="nn">modulos.Posts.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Log</span><span class="p">,</span> <span class="n">Post</span><span class="p">,</span> <span class="n">RestorePost</span><span class="p">,</span> <span class="n">Version</span><span class="p">,</span>
                                  <span class="n">new_creation_log</span><span class="p">,</span> <span class="n">new_edition_log</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">modulos.utils</span> <span class="kn">import</span> <span class="n">new_ctx</span>


<div class="viewcode-block" id="home_view">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.home_view">[documentos]</a>
<span class="k">def</span> <span class="nf">home_view</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista de inicio &#39;home_view&#39;.</span>

<span class="sd">    Combina:</span>
<span class="sd">    - Paginación de los posts recientes.</span>
<span class="sd">    - El post destacado.</span>
<span class="sd">    - Categorías populares.</span>
<span class="sd">    - Posts populares.</span>
<span class="sd">    También maneja la búsqueda de posts a través del formulario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">SearchPostForm</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">GET</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Inicializa el formulario de búsqueda</span>

    <span class="c1"># Obtener el post con más favoritos</span>
    <span class="n">post_destacado</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">favorite_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;favorites&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-favorite_count&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Obtener las tres categorías con más posts marcados como favoritos</span>
    <span class="n">categorias_populares</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post__status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span> <span class="n">post__active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">favorite_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;post__favorites&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-favorite_count&quot;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Obtener los 5 posts más populares (con más favoritos)</span>
    <span class="n">posts_populares</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">favorite_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;favorites&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-favorite_count&quot;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Si hay búsqueda activa</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">):</span>
        <span class="n">input_search</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
        <span class="n">posts_recientes</span> <span class="o">=</span> <span class="n">buscador</span><span class="o">.</span><span class="n">generate_query_set</span><span class="p">(</span><span class="n">input_search</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Obtener los posts publicados más recientes</span>
        <span class="n">posts_recientes</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-publication_date&quot;</span><span class="p">)</span>

    <span class="c1"># Configuración de paginación (10 posts por página)</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">posts_recientes</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">page</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Obtener los posts de la página actual</span>
    <span class="n">posts_paginados</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

    <span class="c1"># Crear el contexto</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">req</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;post_destacado&quot;</span><span class="p">:</span> <span class="n">post_destacado</span><span class="p">,</span>
            <span class="s2">&quot;categorias_populares&quot;</span><span class="p">:</span> <span class="n">categorias_populares</span><span class="p">,</span>
            <span class="s2">&quot;posts_recientes&quot;</span><span class="p">:</span> <span class="n">posts_paginados</span><span class="p">,</span>  <span class="c1"># Los posts paginados o resultados de búsqueda</span>
            <span class="s2">&quot;posts_populares&quot;</span><span class="p">:</span> <span class="n">posts_populares</span><span class="p">,</span>
            <span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>  <span class="c1"># Pasar el formulario de búsqueda</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># Agregar los enlaces de página siguiente y anterior</span>
    <span class="k">if</span> <span class="n">posts_paginados</span><span class="o">.</span><span class="n">has_next</span><span class="p">():</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;next_page&quot;</span><span class="p">:</span> <span class="n">posts_paginados</span><span class="o">.</span><span class="n">next_page_number</span><span class="p">()})</span>

    <span class="k">if</span> <span class="n">posts_paginados</span><span class="o">.</span><span class="n">has_previous</span><span class="p">():</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;previous_page&quot;</span><span class="p">:</span> <span class="n">posts_paginados</span><span class="o">.</span><span class="n">previous_page_number</span><span class="p">()})</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;pages/home.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span></div>



<div class="viewcode-block" id="view_post">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.view_post">[documentos]</a>
<span class="k">def</span> <span class="nf">view_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista de detalle de publicación &#39;PostDetailView&#39;.</span>

<span class="sd">    Esta vista muestra los detalles de un solo objeto &#39;Post&#39;.</span>
<span class="sd">    Utiliza el modelo &#39;Post&#39; para recuperar la instancia específica y renderiza el contenido</span>
<span class="sd">    utilizando la plantilla &#39;posts/post_detail.html&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="c1"># Permitir ver la publicación solo si está publicada o si el usuario es el autor o tiene permisos</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_REVIEW_PERMISSION</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s2">&quot;No tienes permiso para ver esta publicación.&quot;</span><span class="p">)</span>

    <span class="c1"># administrar acceso a categorias moderadas o de pago</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">category</span>

    <span class="c1"># Si la categoría es gratis, mostrar el post completo sin restricción</span>
    <span class="k">if</span> <span class="n">category</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="n">category</span><span class="o">.</span><span class="n">GRATIS</span><span class="p">:</span>
        <span class="c1"># Mostrar el detalle completo del post</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">tags</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>

        <span class="c1"># Verifica si el post es favorito del usuario actual</span>
        <span class="n">es_favorito</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">post</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span>
            <span class="k">else</span> <span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span>
                <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
                <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                <span class="s2">&quot;es_favorito&quot;</span><span class="p">:</span> <span class="n">es_favorito</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/post_detail.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span>

    <span class="c1"># Si el usuario no está autenticado, mostrar la previsualización</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">AnonymousUser</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user_has_access_to_category</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">preview_content</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span>
            <span class="p">:</span><span class="mi">50</span>
        <span class="p">]</span>  <span class="c1"># Truncar a las primeras 50 palabras</span>
        <span class="n">preview_content</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">preview_content</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
        <span class="n">modal_message</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Mensaje diferente según el tipo de categoría</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">AnonymousUser</span><span class="p">):</span>
            <span class="n">modal_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Para poder ver esta publicación debes iniciar sesión o registrarte.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">category</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="n">category</span><span class="o">.</span><span class="n">PREMIUM</span><span class="p">:</span>
            <span class="n">modal_message</span> <span class="o">=</span> <span class="s2">&quot;No tienes acceso a esta publicación. Debes suscribirte para poder ver el contenido pagando 1$.&quot;</span>
        <span class="k">elif</span> <span class="n">category</span><span class="o">.</span><span class="n">tipo</span> <span class="o">==</span> <span class="n">category</span><span class="o">.</span><span class="n">SUSCRIPCION</span><span class="p">:</span>
            <span class="n">modal_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Para poder ver esta publicación debes ser suscriptor de nuestra web.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;pages/post_preview.html&quot;</span><span class="p">,</span>
            <span class="n">new_ctx</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                    <span class="s2">&quot;preview_content&quot;</span><span class="p">:</span> <span class="n">preview_content</span><span class="p">,</span>
                    <span class="s2">&quot;modal_message&quot;</span><span class="p">:</span> <span class="n">modal_message</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Si el usuario tiene acceso, mostrar el detalle completo del post</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">tags</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]</span>

    <span class="c1"># Verifica si el post es favorito del usuario actual</span>
    <span class="n">es_favorito</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">tags</span><span class="p">,</span>
            <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="s2">&quot;es_favorito&quot;</span><span class="p">:</span> <span class="n">es_favorito</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/post_detail.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span></div>



<span class="nd">@login_required</span>
<span class="nd">@permissions_required</span><span class="p">(</span>
    <span class="p">[</span><span class="n">POST_CREATE_PERMISSION</span><span class="p">,</span> <span class="n">POST_EDIT_PERMISSION</span><span class="p">,</span> <span class="n">POST_DELETE_PERMISSION</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">manage_posts</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para gestionar los posts.</span>

<span class="sd">    Esta vista lista todos los posts del usuario actual o de todos los usuarios</span>
<span class="sd">    si el usuario pertenece al grupo &#39;Administrador&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: La respuesta HTTP con el contenido renderizado de la plantilla &#39;pages/post_list.html&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ADMIN</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_admin</span>
        <span class="k">else</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="n">posts</span><span class="p">,</span>
            <span class="s2">&quot;perm_create&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_CREATE_PERMISSION</span><span class="p">),</span>
            <span class="s2">&quot;perm_edit&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_EDIT_PERMISSION</span><span class="p">),</span>
            <span class="s2">&quot;perm_delete&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_DELETE_PERMISSION</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/post_list.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>


<div class="viewcode-block" id="manage_inactive_posts">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.manage_inactive_posts">[documentos]</a>
<span class="k">def</span> <span class="nf">manage_inactive_posts</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para gestionar los posts inactivos.</span>

<span class="sd">    Esta vista lista todos los posts inactivos del usuario actual o de todos los usuarios</span>
<span class="sd">    si el usuario pertenece al grupo &#39;Administrador&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: La respuesta HTTP con el contenido renderizado de la plantilla &#39;pages/post_list.html&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">can_delete</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_DELETE_PERMISSION</span><span class="p">)</span>

    <span class="n">posts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">can_delete</span>
        <span class="k">else</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="n">posts</span><span class="p">,</span> <span class="s2">&quot;can_delete&quot;</span><span class="p">:</span> <span class="n">can_delete</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/inactives_list.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>



<span class="c1"># ----------------</span>
<span class="c1"># Operaciones CRUD</span>
<span class="c1"># ----------------</span>


<span class="nd">@login_required</span>
<span class="nd">@permissions_required</span><span class="p">([</span><span class="n">POST_CREATE_PERMISSION</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_post</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para crear un nuevo post.</span>

<span class="sd">    Esta vista maneja tanto la visualización del formulario como el procesamiento del</span>
<span class="sd">    mismo al enviar los datos. Si el formulario es válido, se crea el post.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Redirección a la vista del post creado o renderización del formulario con errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">NewPostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s2">&quot;Datos proporcionados invalidos&quot;</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="n">p</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># actualizar la cantidad de post creados por el autor</span>
        <span class="n">author</span><span class="o">.</span><span class="n">c_creados</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">new_creation_log</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/posts/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">NewPostForm</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;pages/new_post.html&quot;</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
    <span class="p">)</span>


<div class="viewcode-block" id="inactivate_post">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.inactivate_post">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">inactivate_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para inactivar un post.</span>

<span class="sd">    Esta vista muestra un mensaje de confirmación antes de inactivar un post.</span>
<span class="sd">    Si la solicitud es un POST, se elimina el post y se redirige a la lista de posts.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>
<span class="sd">        id (int): El ID del post a inactivar.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Redirección a la lista de posts o renderización de la confirmación de eliminación.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_DELETE_PERMISSION</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;No tienes permiso para inactivar este post.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">post</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">Log</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Post inactivado por: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">c_audit_eliminados</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;post_list&quot;</span><span class="p">)</span>

    <span class="c1"># Si no es una solicitud POST, muestra un mensaje de confirmación</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/post_confirm_delete.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>



<div class="viewcode-block" id="reactivate_post">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.reactivate_post">[documentos]</a>
<span class="k">def</span> <span class="nf">reactivate_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para reactivar un post.</span>

<span class="sd">    Esta vista vuelve a activar un post que estaba inactivado. Solo aquellos que pueden inactivar</span>
<span class="sd">    un post pueden volver a reactivarlo.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>
<span class="sd">        id (int): El ID del post a inactivar.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Redirección a la lista de posts o renderización de la confirmación de eliminación.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_DELETE_PERMISSION</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No tienes permiso para reactivar este post. Contacta con un administrador&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">post</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">Log</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Post reactivado por: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">c_audit_eliminados</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;post_list&quot;</span><span class="p">)</span>

    <span class="c1"># Si no es una solicitud POST, muestra un mensaje de confirmación</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/post_confirm_reactivation.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>



<span class="nd">@login_required</span>
<span class="nd">@permissions_required</span><span class="p">([</span><span class="n">POST_EDIT_PERMISSION</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">edit_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para editar un post existente.</span>

<span class="sd">    Esta vista carga el formulario con los datos del post y procesa la actualización</span>
<span class="sd">    si se envían nuevos datos.</span>

<span class="sd">    Cuando se realiza una modificacion de un post y el mismo se encuentra en cualquier estado</span>
<span class="sd">    que no sea borrador, entonces se guarda una version del estado anterior del post a modo de historial de</span>
<span class="sd">    cambios.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>
<span class="sd">        id (int): El ID del post a editar.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Redirección a la lista de posts o renderización del formulario con los datos del post.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">old_instance</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;No se puede editar un post inactivo&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">NewPostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">post</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1"># FIX: mostrar errores en el editor</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Formulario inválido&quot;</span><span class="p">)</span>

        <span class="c1"># guardar el post con la version actualizada</span>
        <span class="n">post</span><span class="o">.</span><span class="n">version</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># generar un registro en los logs</span>
        <span class="n">new_edition_log</span><span class="p">(</span><span class="n">old_instance</span><span class="o">=</span><span class="n">old_instance</span><span class="p">,</span> <span class="n">new_instance</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;post_list&quot;</span><span class="p">)</span>

    <span class="c1"># no permitir editar posts ya publicados</span>
    <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No se puede editar un post ya publicado&quot;</span><span class="p">)</span>

    <span class="c1"># solo permitir a editores editar cuando esta pendiente de revision.</span>
    <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">PENDING_REVIEW</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span>
        <span class="n">POST_APPROVE_PERMISSION</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No se puede editar un post pendiente de aprobacion si no es un editor&quot;</span>
        <span class="p">)</span>

    <span class="c1"># solo permitir a publicadores editar cuando esta pendiente de publicacion.</span>
    <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">PENDING_PUBLICATION</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span>
        <span class="n">POST_PUBLISH_PERMISSION</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No se puede editar un post pendiente de publicacion si no es un publicador&quot;</span>
        <span class="p">)</span>

    <span class="c1"># solo permitir a los propios autores editar sus borradores.</span>
    <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">DRAFT</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solo los autores pueden editar un borrador&quot;</span><span class="p">)</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">NewPostForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">post</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/new_post.html&quot;</span><span class="p">,</span> <span class="n">new_ctx</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">}))</span>


<span class="c1"># --------------------</span>
<span class="c1"># Flujo de publicacion</span>
<span class="c1"># --------------------</span>


<span class="nd">@login_required</span>
<span class="nd">@permissions_required</span><span class="p">([</span><span class="n">KANBAN_VIEW_PERMISSION</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">kanban_board</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para mostrar el tablero Kanban con las publicaciones organizadas por estado.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Renderiza la página kanban_board con las publicaciones en sus respectivos estados: borradores, pendientes de revisión,</span>
<span class="sd">        pendientes de publicación y recientemente publicadas. También pasa los permisos del usuario para determinar las acciones disponibles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="c1"># Listar todos los posts o solo los posts si se trata de un publisher/editor</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_PUBLISH_PERMISSION</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_APPROVE_PERMISSION</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_REJECT_PERMISSION</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_DELETE_PERMISSION</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">recently_published</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">publication_date__gte</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">pending_review</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PENDING_REVIEW</span><span class="p">)</span>
        <span class="n">pending_publication</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PENDING_PUBLICATION</span>
        <span class="p">)</span>

    <span class="c1"># De lo contrario listar solo los posts del autor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recently_published</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">publication_date__gte</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">pending_review</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PENDING_REVIEW</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">user</span>
        <span class="p">)</span>
        <span class="n">pending_publication</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PENDING_PUBLICATION</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">user</span>
        <span class="p">)</span>

    <span class="n">drafts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">DRAFT</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># asignar publicacion directa a aquellas publicaciones cuya categoria es de tipo &quot;libre&quot;</span>
    <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">moderacion</span> <span class="o">==</span> <span class="n">Category</span><span class="o">.</span><span class="n">LIBRE</span><span class="p">:</span>
            <span class="n">post</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s2">&quot;can_publish_directly&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">post</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s2">&quot;can_publish_directly&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Pasar las publicaciones a la plantilla para organizarlas en el tablero</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;pages/kanban_board.html&quot;</span><span class="p">,</span>
        <span class="n">new_ctx</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;drafts&quot;</span><span class="p">:</span> <span class="n">drafts</span><span class="p">,</span>
                <span class="s2">&quot;pending_review&quot;</span><span class="p">:</span> <span class="n">pending_review</span><span class="p">,</span>
                <span class="s2">&quot;pending_publication&quot;</span><span class="p">:</span> <span class="n">pending_publication</span><span class="p">,</span>
                <span class="s2">&quot;published&quot;</span><span class="p">:</span> <span class="n">recently_published</span><span class="p">,</span>
                <span class="c1"># permisos para mostrar las acciones sobre las publicaciones</span>
                <span class="s2">&quot;can_create&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_CREATE_PERMISSION</span><span class="p">),</span>
                <span class="s2">&quot;can_publish&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_PUBLISH_PERMISSION</span><span class="p">),</span>
                <span class="s2">&quot;can_approve&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_APPROVE_PERMISSION</span><span class="p">),</span>
                <span class="s2">&quot;can_reject&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_REJECT_PERMISSION</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">),</span>
    <span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permissions_required</span><span class="p">([</span><span class="n">POST_CREATE_PERMISSION</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">send_to_review</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para enviar una publicación a revisión.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        id: El ID del post que se va a enviar a revisión.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Redirige al tablero Kanban una vez que el estado del post se ha actualizado a &#39;Pendiente de Revisión&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;No se puede enviar a review un post inactivo&quot;</span><span class="p">)</span>

    <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">PENDING_REVIEW</span>
    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;kanban_board&quot;</span><span class="p">)</span>


<span class="nd">@login_required</span>
<span class="nd">@permissions_required</span><span class="p">([</span><span class="n">POST_APPROVE_PERMISSION</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">aprove_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para aprobar una publicación y pasarla al estado de &#39;Pendiente de Publicación&#39;.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        id: El ID del post que se va a aprobar.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Redirige al tablero Kanban después de cambiar el estado del post a &#39;Pendiente de Publicación&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;No se puede enviar a review un post inactivo&quot;</span><span class="p">)</span>

    <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">PENDING_PUBLICATION</span>
    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># actualizar las estadisticas del editor y el autor</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span>
    <span class="n">editor</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="n">editor</span><span class="o">.</span><span class="n">c_audit_revisados</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">author</span><span class="o">.</span><span class="n">c_aprobados</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">editor</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;kanban_board&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="publish_post">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.publish_post">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">publish_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para publicar una publicación.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        id: El ID del post que se va a publicar.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Redirige al tablero Kanban una vez que el estado del post se ha actualizado a &#39;Publicado&#39; y se ha registrado la fecha de publicación.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;No se puede publicar un post inactivo&quot;</span><span class="p">)</span>

    <span class="n">category</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">category</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_PUBLISH_PERMISSION</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">category</span><span class="o">.</span><span class="n">moderacion</span> <span class="o">==</span> <span class="n">Category</span><span class="o">.</span><span class="n">LIBRE</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No tienes permisos para publicar en esta categoria&quot;</span>
        <span class="p">)</span>

    <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span>
    <span class="n">post</span><span class="o">.</span><span class="n">publication_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># actualizar las estadisticas del publicador y el autor</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="n">publisher</span><span class="o">.</span><span class="n">c_audit_publicados</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">author</span><span class="o">.</span><span class="n">c_publicados</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">publisher</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;kanban_board&quot;</span><span class="p">)</span></div>



<span class="nd">@login_required</span>
<span class="nd">@permissions_required</span><span class="p">([</span><span class="n">POST_REJECT_PERMISSION</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">reject_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para rechazar una publicación y devolverla al estado de &#39;Borrador&#39;.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        id: El ID del post que se va a rechazar.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Redirige al tablero Kanban después de cambiar el estado del post a &#39;Borrador&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;No se puede rechazar un post inactivo&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No puedes tocar el estado de un post ya publicado&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Retrasar un paoso el estado de publicacion</span>
    <span class="k">if</span> <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">PENDING_REVIEW</span><span class="p">:</span>
        <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">DRAFT</span>
    <span class="k">elif</span> <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">post</span><span class="o">.</span><span class="n">PENDING_PUBLICATION</span><span class="p">:</span>
        <span class="n">post</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">PENDING_REVIEW</span>

    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># actualizar las estadisticas del auditor y el autor</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span>
    <span class="n">audit</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

    <span class="n">audit</span><span class="o">.</span><span class="n">c_audit_rechazados</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">author</span><span class="o">.</span><span class="n">c_rechazados</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">audit</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;kanban_board&quot;</span><span class="p">)</span>


<span class="c1"># --------------------</span>
<span class="c1">#      Varios</span>
<span class="c1"># --------------------</span>


<div class="viewcode-block" id="enhanced_search">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.enhanced_search">[documentos]</a>
<span class="k">def</span> <span class="nf">enhanced_search</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">SearchPostForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;home&quot;</span><span class="p">)</span>

    <span class="nb">input</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">buscador</span><span class="o">.</span><span class="n">generate_query_set</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;posts&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span> <span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">SearchPostForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="p">})}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/search_results.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">)</span></div>



<div class="viewcode-block" id="favorite_post">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.favorite_post">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">favorite_post</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para marcar o desmarcar un post como favorito.</span>

<span class="sd">    Esta vista maneja la acción de agregar o quitar un post de la lista de favoritos</span>
<span class="sd">    del usuario actual.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>
<span class="sd">        id (int): El ID del post a marcar como favorito.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: Respuesta HTTP con un código de estado 204 (sin contenido).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>  <span class="c1"># Obtiene el post o devuelve un error 404</span>

    <span class="c1"># Si el post ya es favorito lo agrega, si no lo elimina</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">post</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">post</span><span class="o">.</span><span class="n">favorites</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;post_detail&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span></div>



<div class="viewcode-block" id="favorite_list">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.favorite_list">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">favorite_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para listar los posts favoritos del usuario y las categorías de interés.</span>

<span class="sd">    Args:</span>
<span class="sd">        request (HttpRequest): El objeto de solicitud HTTP.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpResponse: La respuesta HTTP con el contenido renderizado de la plantilla &#39;pages/posts_favorites_list.html&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtener los posts favoritos</span>
    <span class="n">posts_favorites</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">favorites</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Paginación: 5 posts por página</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">posts_favorites</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 5 posts por página</span>
    <span class="n">page_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">)</span>  <span class="c1"># Obtiene el número de la página actual</span>
    <span class="n">posts_favorites_paginados</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>  <span class="c1"># Paginación</span>

    <span class="c1"># Obtener las categorías de los posts favoritos (sin duplicados)</span>
    <span class="n">categorias_interes</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">post__favorites</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;posts_favorites&quot;</span><span class="p">:</span> <span class="n">posts_favorites_paginados</span><span class="p">,</span>  <span class="c1"># Pasamos la lista paginada</span>
            <span class="s2">&quot;categorias_interes&quot;</span><span class="p">:</span> <span class="n">categorias_interes</span><span class="p">,</span>  <span class="c1"># Pasar las categorías al contexto</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/posts_favorites_list.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>



<div class="viewcode-block" id="list_contenidos_view">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.list_contenidos_view">[documentos]</a>
<span class="k">def</span> <span class="nf">list_contenidos_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para listar todos los contenidos por categoría con opción de búsqueda y filtrado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">categories</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">post__status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span> <span class="n">post__active</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>

    <span class="c1"># Inicializa el formulario de búsqueda con los parámetros GET si existen</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">PostsListFilter</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Construimos un query dinámico para los filtros</span>
    <span class="n">posts_query</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Aplicar filtros si el formulario es válido</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
        <span class="c1"># Filtro por palabra clave en el título o contenido</span>
        <span class="n">input_search</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_search</span><span class="p">:</span>
            <span class="n">posts_query</span> <span class="o">=</span> <span class="n">posts_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">title__icontains</span><span class="o">=</span><span class="n">input_search</span><span class="p">))</span>

        <span class="c1"># Filtro por categoría</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="n">posts_query</span> <span class="o">=</span> <span class="n">posts_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>

        <span class="c1"># Filtro por autor</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">author</span><span class="p">:</span>
            <span class="n">posts_query</span> <span class="o">=</span> <span class="n">posts_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author__username__icontains</span><span class="o">=</span><span class="n">author</span><span class="p">)</span>

        <span class="c1"># Filtro por fecha de publicación</span>
        <span class="n">publication_date</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publication_date&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">publication_date</span><span class="p">:</span>
            <span class="n">posts_query</span> <span class="o">=</span> <span class="n">posts_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">publication_date</span><span class="o">=</span><span class="n">publication_date</span><span class="p">)</span>

    <span class="c1"># Crear un diccionario para almacenar los posts paginados por categoría</span>
    <span class="n">posts_by_category</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
        <span class="n">filtered_posts</span> <span class="o">=</span> <span class="n">posts_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>

        <span class="c1"># Paginación: 6 posts por página para cada categoría</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span><span class="p">(</span><span class="n">filtered_posts</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># 6 posts por página</span>
        <span class="n">page_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;page_</span><span class="si">{</span><span class="n">category</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># Se captura la página de cada categoría</span>
        <span class="n">page_obj</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">get_page</span><span class="p">(</span><span class="n">page_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filtered_posts</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">posts_by_category</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">page_obj</span>

    <span class="c1"># Crear el contexto y pasarlo a la plantilla</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;posts_by_category&quot;</span><span class="p">:</span> <span class="n">posts_by_category</span><span class="p">,</span>
            <span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>  <span class="c1"># Pasar el formulario al contexto</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/list_contenidos.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>



<span class="c1"># --------------------</span>
<span class="c1">#    Estadisticas</span>
<span class="c1"># --------------------</span>


<div class="viewcode-block" id="post_log_list">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.post_log_list">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">post_log_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para listar los registros de un post específico.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        id: El ID del post para obtener sus registros.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Renderiza la página logs_list con los registros del post, o devuelve un</span>
<span class="sd">        HttpResponseForbidden si el usuario no tiene permisos o no es el autor del post.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_REVIEW_PERMISSION</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No tienes permisos para acceder a los logs de este post&quot;</span>
        <span class="p">)</span>

    <span class="n">logs</span> <span class="o">=</span> <span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-creation_date&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/logs_list.html&quot;</span><span class="p">,</span> <span class="n">new_ctx</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="n">logs</span><span class="p">}))</span></div>



<div class="viewcode-block" id="post_versions_list">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.post_versions_list">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">post_versions_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para listar todas las versiones de un post específico.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        id: El ID del post para obtener sus versiones.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Renderiza la página post_versions_list con las versiones del post.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_REVIEW_PERMISSION</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No tienes permisos para acceder al registro de versiones de este post&quot;</span>
        <span class="p">)</span>

    <span class="n">versions</span> <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post_id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;versions&quot;</span><span class="p">:</span> <span class="n">versions</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/post_versions_list.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>



<div class="viewcode-block" id="post_version_detail">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.post_version_detail">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">post_version_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">post_id</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para mostrar detalles y diferencias entre el contenido actual del post y una versión específica.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        post_id: El ID del post.</span>
<span class="sd">        version: El número de versión del post para comparar.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Renderiza la página post_version_detail con las diferencias entre el contenido de la versión y el contenido actual del post.</span>
<span class="sd">        Si el usuario no tiene permisos o no es el autor del post, devuelve un HttpResponseForbidden.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_REVIEW_PERMISSION</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">original</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No tienes permisos para acceder a las versiones de este post&quot;</span>
        <span class="p">)</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">post_id</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">post_content</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">version_content</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span>
        <span class="n">version_content</span><span class="p">,</span>
        <span class="n">post_content</span><span class="p">,</span>
        <span class="n">fromfile</span><span class="o">=</span><span class="s2">&quot;Comparacion.md&quot;</span><span class="p">,</span>
        <span class="n">tofile</span><span class="o">=</span><span class="s2">&quot;Comparacion.md&quot;</span><span class="p">,</span>
        <span class="n">lineterm</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

    <span class="c1"># Pasamos el diff a la plantilla</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;original&quot;</span><span class="p">:</span> <span class="n">original</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span> <span class="s2">&quot;diff_content&quot;</span><span class="p">:</span> <span class="n">diff</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/post_version_detail.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>



<div class="viewcode-block" id="post_revert_version">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.post_revert_version">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">post_revert_version</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">post_id</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para revertir un post a una versión anterior.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        post_id: El ID del post que se quiere revertir.</span>
<span class="sd">        version: El número de versión a la que se desea revertir el post.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Redirige a la lista de versiones del post después de haber restaurado la versión seleccionada.</span>
<span class="sd">        Si el usuario no tiene permisos o no es el autor del post, devuelve un HttpResponseForbidden.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">original</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;No se puede modificar un post inactivo&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_EDIT_PERMISSION</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">original</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No tienes permisos para acceder a las versiones de este post&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Evitar que un post en estado publicado pueda ser revertido</span>
    <span class="k">if</span> <span class="n">original</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">original</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s2">&quot;Un post publicado no puede ser revertido&quot;</span><span class="p">)</span>

    <span class="c1"># Que no se pueda hacer reversion durante el proceso de edicion/aprobacion/publicacion</span>
    <span class="c1"># a menos que este en &quot;derecho&quot; de realizar dicha modificacion.</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">post_id</span><span class="o">=</span><span class="n">original</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">RestorePost</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;post_versions&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">post_id</span><span class="p">}))</span></div>



<div class="viewcode-block" id="post_statistics">
<a class="viewcode-back" href="../../../docs/source/modulos.Posts.html#modulos.Posts.views.post_statistics">[documentos]</a>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">post_statistics</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vista para mostrar estadísticas de un post específico.</span>

<span class="sd">    Argumentos:</span>
<span class="sd">        request: El objeto de solicitud HTTP.</span>
<span class="sd">        id: El ID del post para obtener sus estadísticas.</span>

<span class="sd">    Retorna:</span>
<span class="sd">        Renderiza la página statistics con los registros, versiones y estadísticas de Disqus del post.</span>
<span class="sd">        Si el usuario no tiene permisos o no es el autor del post, devuelve un HttpResponseForbidden.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">POST_REVIEW_PERMISSION</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">post</span><span class="o">.</span><span class="n">author</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span>
            <span class="s2">&quot;No tienes permisos para acceder a las estadisticas de este post&quot;</span>
        <span class="p">)</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">new_ctx</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;post&quot;</span><span class="p">:</span> <span class="n">post</span><span class="p">,</span>
            <span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="n">Log</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-id&quot;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;versions&quot;</span><span class="p">:</span> <span class="n">Version</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post_id</span><span class="o">=</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-id&quot;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;disqus&quot;</span><span class="p">:</span> <span class="n">get_disqus_stats</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;pages/statistics.html&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Proyecto IS2 grupo 6</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Ir a" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navegación</h3>
<p class="caption" role="heading"><span class="caption-text">Table of Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modules.html">modulos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.html">modulos package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Authorization.html">modulos.Authorization package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Authorization.management.html">modulos.Authorization.management package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Authorization.management.commands.html">modulos.Authorization.management.commands package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Categories.html">modulos.Categories package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Categories.migrations.html">modulos.Categories.migrations package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Pagos.html">modulos.Pagos package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Pagos.migrations.html">modulos.Pagos.migrations package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Posts.html">modulos.Posts package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Posts.buscador.html">modulos.Posts.buscador package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Posts.migrations.html">modulos.Posts.migrations package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Reports.html">modulos.Reports package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.Reports.migrations.html">modulos.Reports.migrations package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.UserProfile.html">modulos.UserProfile package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.UserProfile.management.html">modulos.UserProfile.management package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.UserProfile.management.commands.html">modulos.UserProfile.management.commands package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.UserProfile.migrations.html">modulos.UserProfile.migrations package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/source/modulos.mdeditor.html">modulos.mdeditor package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Código de módulo</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Grupo 6 IS2.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.0.2</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>